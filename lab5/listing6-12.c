/* Listing 6-12 from textbook (The Art of Software Security Assessment by
 *                            Dowd, McDonald, and Schuh)
 */

unsigned short read_length(int sockfd)
{
    unsigned short len;

    if(full_read(sockfd, (void *)&len, 2) != 2)
        die("could not read length!\n");

    return ntohs(len);
}

int read_packet(int sockfd)
{
    struct header hdr;
    short length;
    char *buffer;

    length = read_length(sockfd);

    if(length > 1024){
        error("read_packet: length too large: %d\n", length);
        return -1;
    }

    buffer = (char *)malloc(length+1);

    if((n = read(sockfd, buffer, length)) < 0){
        error("read: %m");
        free(buffer);
        return -1;
    }

    buffer[n] = '\0';

    return 0;
}
